-- ===================================================
-- ЛАБОРАТОРНАЯ РАБОТА №6 - ТРИГГЕРЫ
-- БАЗА ДАННЫХ: Расписание_занятий_Л
-- ===================================================

USE Расписание_занятий_Л;
GO

-- ===================================================
-- СОЗДАНИЕ ТАБЛИЦЫ ДЛЯ ЛОГИРОВАНИЯ ИЗМЕНЕНИЙ
-- ===================================================

CREATE TABLE Логи_изменений (
    id INT IDENTITY(1,1) PRIMARY KEY,
    таблица NVARCHAR(50) NOT NULL,
    операция NVARCHAR(10) NOT NULL,
    ключ_записи NVARCHAR(100),
    старые_данные NVARCHAR(MAX),
    новые_данные NVARCHAR(MAX),
    пользователь NVARCHAR(100) DEFAULT SYSTEM_USER,
    дата_изменения DATETIME DEFAULT GETDATE()
);
GO

-- ===================================================
-- 1. ТРИГГЕРЫ INSERT
-- ===================================================

-- Триггер INSERT для таблицы Расписание - проверка конфликтов
CREATE TRIGGER tr_Расписание_INSERT
ON Расписание
AFTER INSERT
AS
BEGIN
    SET NOCOUNT ON;
    
    -- Проверка на занятость аудитории
    IF EXISTS (
        SELECT 1 FROM inserted i
        INNER JOIN Расписание р ON i.день_недели = р.день_недели 
            AND i.номер_занятия = р.номер_занятия 
            AND i.номер_ауд = р.номер_ауд
        WHERE р.код_группы != i.код_группы
    )
    BEGIN
        RAISERROR('Ошибка: Аудитория уже занята в это время!', 16, 1);
        ROLLBACK TRANSACTION;
        RETURN;
    END
    
    -- Проверка на занятость преподавателя
    IF EXISTS (
        SELECT 1 FROM inserted i
        INNER JOIN Расписание р ON i.день_недели = р.день_недели 
            AND i.номер_занятия = р.номер_занятия 
            AND i.код_преподавателя = р.код_преподавателя
        WHERE р.код_группы != i.код_группы
    )
    BEGIN
        RAISERROR('Ошибка: Преподаватель уже занят в это время!', 16, 1);
        ROLLBACK TRANSACTION;
        RETURN;
    END
    
    -- Проверка на занятость группы
    IF EXISTS (
        SELECT 1 FROM inserted i
        INNER JOIN Расписание р ON i.день_недели = р.день_недели 
            AND i.номер_занятия = р.номер_занятия 
            AND i.код_группы = р.код_группы
        WHERE р.номер_ауд != i.номер_ауд
    )
    BEGIN
        RAISERROR('Ошибка: Группа уже имеет занятие в это время!', 16, 1);
        ROLLBACK TRANSACTION;
        RETURN;
    END
    
    -- Логирование успешного добавления
    INSERT INTO Логи_изменений (таблица, операция, ключ_записи, новые_данные)
    SELECT 
        'Расписание',
        'INSERT',
        CONCAT(день_недели, '-', номер_занятия, '-', код_группы),
        (SELECT * FROM inserted FOR JSON PATH)
    FROM inserted;
    
    PRINT 'Занятие успешно добавлено в расписание';
END;
GO

-- Триггер INSERT для таблицы Преподаватели - автоматическое логирование
CREATE TRIGGER tr_Преподаватели_INSERT
ON Преподаватели
AFTER INSERT
AS
BEGIN
    SET NOCOUNT ON;
    
    INSERT INTO Логи_изменений (таблица, операция, ключ_записи, новые_данные)
    SELECT 
        'Преподаватели',
        'INSERT',
        CAST(код_преподавателя AS NVARCHAR(10)),
        CONCAT('ФИО: ', ФИО, ', Кафедра: ', код_кафедры)
    FROM inserted;
    
    PRINT 'Новый преподаватель добавлен в систему';
END;
GO

-- ===================================================
-- 2. ТРИГГЕРЫ UPDATE
-- ===================================================

-- Триггер UPDATE для таблицы Группа - контроль изменений численности
CREATE TRIGGER tr_Группа_UPDATE
ON Группа
AFTER UPDATE
AS
BEGIN
    SET NOCOUNT ON;
    
    -- Проверка изменения численности группы
    IF UPDATE(численность_группы)
    BEGIN
        -- Логирование изменения численности
        INSERT INTO Логи_изменений (таблица, операция, ключ_записи, старые_данные, новые_данные)
        SELECT 
            'Группа',
            'UPDATE',
            CAST(i.код_группы AS NVARCHAR(10)),
            CONCAT('Группа: ', d.наименование, ', Численность: ', d.численность_группы),
            CONCAT('Группа: ', i.наименование, ', Численность: ', i.численность_группы)
        FROM inserted i
        INNER JOIN deleted d ON i.код_группы = d.код_группы;
        
        PRINT 'Численность группы изменена';
    END
    
    -- Проверка изменения курса
    IF UPDATE(Курс)
    BEGIN
        DECLARE @старый_курс INT, @новый_курс INT, @код_группы INT;
        
        SELECT @старый_курс = Курс FROM deleted;
        SELECT @новый_курс = Курс, @код_группы = код_группы FROM inserted;
        
        IF @новый_курс > 5
        BEGIN
            RAISERROR('Ошибка: Курс не может быть больше 5!', 16, 1);
            ROLLBACK TRANSACTION;
            RETURN;
        END
    END
END;
GO

-- Триггер UPDATE для таблицы Аудитории - защита от уменьшения мест
CREATE TRIGGER tr_Аудитории_UPDATE
ON Аудитории
AFTER UPDATE
AS
BEGIN
    SET NOCOUNT ON;
    
    -- Запрет на уменьшение количества посадочных мест
    IF UPDATE(количество_посадочных_мест)
    BEGIN
        IF EXISTS (
            SELECT 1 FROM inserted i
            INNER JOIN deleted d ON i.номер_ауд = d.номер_ауд
            WHERE i.количество_посадочных_мест < d.количество_посадочных_мест
        )
        BEGIN
            RAISERROR('Ошибка: Нельзя уменьшать количество посадочных мест!', 16, 1);
            ROLLBACK TRANSACTION;
            RETURN;
        END
        
        -- Логирование изменения
        INSERT INTO Логи_изменений (таблица, операция, ключ_записи, старые_данные, новые_данные)
        SELECT 
            'Аудитории',
            'UPDATE',
            CAST(i.номер_ауд AS NVARCHAR(10)),
            CONCAT('Аудитория: ', d.номер_ауд, ', Мест: ', d.количество_посадочных_мест),
            CONCAT('Аудитория: ', i.номер_ауд, ', Мест: ', i.количество_посадочных_мест)
        FROM inserted i
        INNER JOIN deleted d ON i.номер_ауд = d.номер_ауд;
    END
END;
GO

-- ===================================================
-- 3. ТРИГГЕРЫ DELETE
-- ===================================================

-- Триггер DELETE для таблицы Кафедры - защита от удаления используемых кафедр
CREATE TRIGGER tr_Кафедры_DELETE
ON Кафедры
INSTEAD OF DELETE
AS
BEGIN
    SET NOCOUNT ON;
    
    -- Проверка на наличие связанных преподавателей
    IF EXISTS (
        SELECT 1 FROM deleted d
        INNER JOIN Преподаватели п ON d.код_кафедры = п.код_кафедры
    )
    BEGIN
        RAISERROR('Ошибка: Нельзя удалить кафедру с привязанными преподавателями!', 16, 1);
        RETURN;
    END
    
    -- Проверка на наличие связанных групп
    IF EXISTS (
        SELECT 1 FROM deleted d
        INNER JOIN Группа г ON d.код_кафедры = г.код_кафедры
    )
    BEGIN
        RAISERROR('Ошибка: Нельзя удалить кафедру с привязанными группами!', 16, 1);
        RETURN;
    END
    
    -- Логирование удаления
    INSERT INTO Логи_изменений (таблица, операция, ключ_записи, старые_данные)
    SELECT 
        'Кафедры',
        'DELETE',
        CAST(код_кафедры AS NVARCHAR(10)),
        CONCAT('Кафедра: ', наименование)
    FROM deleted;
    
    -- Выполнение удаления
    DELETE FROM Кафедры 
    WHERE код_кафедры IN (SELECT код_кафедры FROM deleted);
    
    PRINT 'Кафедра успешно удалена';
END;
GO

-- Триггер DELETE для таблицы Расписание - архивное копирование
CREATE TRIGGER tr_Расписание_DELETE
ON Расписание
AFTER DELETE
AS
BEGIN
    SET NOCOUNT ON;
    
    -- Создаем архивную таблицу если её нет
    IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'Архив_Расписание')
    BEGIN
        CREATE TABLE Архив_Расписание (
            день_недели NVARCHAR(15),
            номер_занятия INT,
            код_группы INT,
            код_предмета INT,
            код_типа_занятий INT,
            номер_ауд INT,
            код_преподавателя INT,
            дата_удаления DATETIME DEFAULT GETDATE(),
            пользователь_удалил NVARCHAR(100) DEFAULT SYSTEM_USER
        );
    END
    
    -- Копируем удаленные записи в архив
    INSERT INTO Архив_Расписание (день_недели, номер_занятия, код_группы, код_предмета, код_типа_занятий, номер_ауд, код_преподавателя)
    SELECT день_недели, номер_занятия, код_группы, код_предмета, код_типа_занятий, номер_ауд, код_преподавателя
    FROM deleted;
    
    -- Логирование удаления
    INSERT INTO Логи_изменений (таблица, операция, ключ_записи, старые_данные)
    SELECT 
        'Расписание',
        'DELETE',
        CONCAT(день_недели, '-', номер_занятия, '-', код_группы),
        (SELECT * FROM deleted FOR JSON PATH)
    FROM deleted;
    
    PRINT 'Запись расписания удалена и сохранена в архиве';
END;
GO

-- ===================================================
-- 4. ТРИГГЕРЫ НА ПРЕДСТАВЛЕНИЯ
-- ===================================================

-- Создаем представление для тестирования триггеров
CREATE VIEW vw_ГруппыСКафедрами
AS
SELECT 
    г.код_группы,
    г.наименование AS Группа,
    г.численность_группы,
    г.Курс,
    к.наименование AS Кафедра
FROM Группа г
LEFT JOIN Кафедры к ON г.код_кафедры = к.код_кафедры;
GO

-- Триггер INSTEAD OF INSERT для представления
CREATE TRIGGER tr_vw_ГруппыСКафедрами_INSERT
ON vw_ГруппыСКафедрами
INSTEAD OF INSERT
AS
BEGIN
    SET NOCOUNT ON;
    
    -- Вставляем данные в основную таблицу
    INSERT INTO Группа (код_группы, наименование, численность_группы, Курс, код_кафедры)
    SELECT 
        i.код_группы,
        i.Группа,
        i.численность_группы,
        i.Курс,
        к.код_кафедры
    FROM inserted i
    LEFT JOIN Кафедры к ON i.Кафедра = к.наименование;
    
    PRINT 'Данные добавлены через представление';
END;
GO

-- Триггер INSTEAD OF UPDATE для представления
CREATE TRIGGER tr_vw_ГруппыСКафедрами_UPDATE
ON vw_ГруппыСКафедрами
INSTEAD OF UPDATE
AS
BEGIN
    SET NOCOUNT ON;
    
    -- Обновляем данные в основной таблице
    UPDATE Группа
    SET 
        наименование = i.Группа,
        численность_группы = i.численность_группы,
        Курс = i.Курс,
        код_кафедры = к.код_кафедры
    FROM inserted i
    LEFT JOIN Кафедры к ON i.Кафедра = к.наименование
    WHERE Группа.код_группы = i.код_группы;
    
    PRINT 'Данные обновлены через представление';
END;
GO

-- ===================================================
-- 5. КОМПЛЕКСНЫЙ ТРИГГЕР ДЛЯ АВТОМАТИЧЕСКОГО ОБНОВЛЕНИЯ ЗАНЯТОСТИ
-- ===================================================

CREATE TRIGGER tr_Расписание_Комплексный
ON Расписание
AFTER INSERT, UPDATE, DELETE
AS
BEGIN
    SET NOCOUNT ON;
    
    -- Обработка INSERT - отмечаем занятость
    IF EXISTS (SELECT * FROM inserted) AND NOT EXISTS (SELECT * FROM deleted)
    BEGIN
        -- Обновляем занятость аудиторий
        INSERT INTO Занятость_аудиторий (код_ауд, номер_занятия, день_недели, признак_занятости)
        SELECT номер_ауд, номер_занятия, день_недели, 1
        FROM inserted;
        
        -- Обновляем занятость преподавателей
        INSERT INTO Занятость_препод (код_преподавателя, номер_занятия, день_недели, признак_занятости)
        SELECT код_преподавателя, номер_занятия, день_недели, 1
        FROM inserted;
        
        -- Обновляем занятость групп
        INSERT INTO Занятость_группы (код_группы, номер_занятия, день_недели, признак_занятости)
        SELECT код_группы, номер_занятия, день_недели, 1
        FROM inserted;
    END
    
    -- Обработка DELETE - освобождаем занятость
    IF EXISTS (SELECT * FROM deleted) AND NOT EXISTS (SELECT * FROM inserted)
    BEGIN
        -- Освобождаем аудитории
        DELETE FROM Занятость_аудиторий 
        WHERE EXISTS (
            SELECT 1 FROM deleted d 
            WHERE Занятость_аудиторий.код_ауд = d.номер_ауд 
            AND Занятость_аудиторий.номер_занятия = d.номер_занятия 
            AND Занятость_аудиторий.день_недели = d.день_недели
        );
        
        -- Освобождаем преподавателей
        DELETE FROM Занятость_препод 
        WHERE EXISTS (
            SELECT 1 FROM deleted d 
            WHERE Занятость_препод.код_преподавателя = d.код_преподавателя 
            AND Занятость_препод.номер_занятия = d.номер_занятия 
            AND Занятость_препод.день_недели = d.день_недели
        );
        
        -- Освобождаем группы
        DELETE FROM Занятость_группы 
        WHERE EXISTS (
            SELECT 1 FROM deleted d 
            WHERE Занятость_группы.код_группы = d.код_группы 
            AND Занятость_группы.номер_занятия = d.номер_занятия 
            AND Занятость_группы.день_недели = d.день_недели
        );
    END
END;
GO

-- ===================================================
-- ТЕСТИРОВАНИЕ ТРИГГЕРОВ
-- ===================================================

PRINT '=== ТЕСТИРОВАНИЕ ТРИГГЕРОВ ===';
GO

-- Тест INSERT триггера
PRINT '1. Тест INSERT триггера (добавление занятия):';
BEGIN TRY
    INSERT INTO Расписание (день_недели, номер_занятия, код_группы, код_предмета, код_типа_занятий, номер_ауд, код_преподавателя)
    VALUES ('Понедельник', 1, 1, 1, 1, 101, 1);
END TRY
BEGIN CATCH
    PRINT 'Ожидаемая ошибка: ' + ERROR_MESSAGE();
END CATCH
GO

-- Тест UPDATE триггера
PRINT '2. Тест UPDATE триггера (изменение численности группы):';
UPDATE Группа SET численность_группы = 28 WHERE код_группы = 1;
GO

-- Тест DELETE триггера
PRINT '3. Тест DELETE триггера (удаление кафедры):';
BEGIN TRY
    DELETE FROM Кафедры WHERE код_кафедры = 1;
END TRY
BEGIN CATCH
    PRINT 'Ожидаемая ошибка: ' + ERROR_MESSAGE();
END CATCH
GO

-- Тест представления с триггером
PRINT '4. Тест триггера на представлении:';
INSERT INTO vw_ГруппыСКафедрами (код_группы, Группа, численность_группы, Курс, Кафедра)
VALUES (17, 'TEST-25-1', 20, 1, 'Кафедра информатики и вычислительной техники');
GO

-- Просмотр логов
PRINT '5. Просмотр логов изменений:';
SELECT * FROM Логи_изменений ORDER BY дата_изменения DESC;
GO

-- Просмотр архивных данных
PRINT '6. Просмотр архивных данных:';
IF EXISTS (SELECT * FROM sys.tables WHERE name = 'Архив_Расписание')
    SELECT * FROM Архив_Расписание;
GO

-- ===================================================
-- ИТОГОВАЯ ИНФОРМАЦИЯ
-- ===================================================

PRINT '=== ИНФОРМАЦИЯ О СОЗДАННЫХ ТРИГГЕРАХ ===';
SELECT 
    name AS Имя_триггера,
    object_name(parent_id) AS Таблица,
    CASE 
        WHEN is_instead_of_trigger = 1 THEN 'INSTEAD OF'
        ELSE 'AFTER'
    END AS Тип_триггера,
    create_date AS Дата_создания
FROM sys.triggers 
WHERE name LIKE 'tr_%'
ORDER BY Таблица, Тип_триггера;
GO

PRINT '=== ЛАБОРАТОРНАЯ РАБОТА №6 ВЫПОЛНЕНА! ===';
PRINT '=== СОЗДАНО: ===';
PRINT '- 2 INSERT триггера (Расписание, Преподаватели)';
PRINT '- 2 UPDATE триггера (Группа, Аудитории)';
PRINT '- 2 DELETE триггера (Кафедры, Расписание)';
PRINT '- 2 триггера на представления (INSERT, UPDATE)';
PRINT '- 1 комплексный триггер для автоматического обновления занятости';
PRINT '- Таблица для логирования изменений';
PRINT '=== ВСЕ ТРИГГЕРЫ ПРОТЕСТИРОВАНЫ ===';