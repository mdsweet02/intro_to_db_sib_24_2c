-- ===================================================
-- ЛАБОРАТОРНАЯ РАБОТА №4 - ВСЕ 3 ЗАДАНИЯ
-- БАЗА ДАННЫХ: Расписание_занятий_Л
-- ===================================================

USE Расписание_занятий_Л;
GO

-- ===================================================
-- ЗАДАНИЕ 1: ПРЕДСТАВЛЕНИЯ ДЛЯ ОТЧЕТОВ
-- ===================================================

-- 1.1. ОТЧЕТ: Полное расписание с детальной информацией
CREATE VIEW vw_Отчет_Полное_Расписание AS
SELECT 
    гр.наименование AS Группа,
    гр.Курс,
    р.день_недели,
    р.номер_занятия,
    пер.время_начала,
    пер.время_окончания,
    пр.наименование AS Предмет,
    тип.наименование AS Тип_занятия,
    ау.номер_ауд AS Аудитория,
    ау.количество_посадочных_мест,
    прп.ФИО AS Преподаватель,
    к.наименование AS Кафедра
FROM Расписание р
INNER JOIN Группа гр ON р.код_группы = гр.код_группы
INNER JOIN Период_проведения_занятий пер ON р.номер_занятия = пер.номер_занятия
INNER JOIN Предметы пр ON р.код_предмета = пр.код_предмета
INNER JOIN Тип_занятий_аудиторий тип ON р.код_типа_занятий = тип.код
INNER JOIN Аудитории ау ON р.номер_ауд = ау.номер_ауд
INNER JOIN Преподаватели прп ON р.код_преподавателя = прп.код_преподавателя
INNER JOIN Кафедры к ON прп.код_кафедры = к.код_кафедры;
GO

-- 1.2. ОТЧЕТ: Нагрузка преподавателей по дням недели
CREATE VIEW vw_Отчет_Нагрузка_Преподавателей AS
SELECT 
    прп.ФИО AS Преподаватель,
    к.наименование AS Кафедра,
    р.день_недели,
    COUNT(*) AS Количество_занятий,
    STRING_AGG(пр.наименование, ', ') AS Преподаваемые_предметы
FROM Преподаватели прп
INNER JOIN Кафедры к ON прп.код_кафедры = к.код_кафедры
INNER JOIN Расписание р ON прп.код_преподавателя = р.код_преподавателя
INNER JOIN Предметы пр ON р.код_предмета = пр.код_предмета
GROUP BY прп.ФИО, к.наименование, р.день_недели;
GO

-- 1.3. ОТЧЕТ: Статистика использования аудиторий
CREATE VIEW vw_Отчет_Статистика_Аудиторий AS
SELECT 
    ау.номер_ауд AS Аудитория,
    тип.наименование AS Тип_аудитории,
    ау.количество_посадочных_мест,
    COUNT(р.номер_занятия) AS Занятых_пар_в_неделю,
    (COUNT(р.номер_занятия) * 100.0 / 36) AS Процент_занятости
FROM Аудитории ау
INNER JOIN Тип_занятий_аудиторий тип ON ау.код_типа_занятий = тип.код
LEFT JOIN Расписание р ON ау.номер_ауд = р.номер_ауд
GROUP BY ау.номер_ауд, тип.наименование, ау.количество_посадочных_мест;
GO

-- ===================================================
-- ЗАДАНИЕ 2: ПРЕДСТАВЛЕНИЕ ДЛЯ КОРРЕКТИРОВКИ (2+ ТАБЛИЦЫ)
-- ===================================================

CREATE VIEW vw_Корректировка_Расписания AS
SELECT 
    р.день_недели,
    р.номер_занятия,
    р.код_группы,
    гр.наименование AS Группа,
    гр.Курс,
    р.код_предмета,
    пр.наименование AS Предмет,
    р.код_типа_занятий,
    т.наименование AS Тип_занятия,
    р.номер_ауд,
    ау.количество_посадочных_мест,
    р.код_преподавателя,
    прп.ФИО AS Преподаватель,
    к.наименование AS Кафедра_преподавателя
FROM Расписание р
INNER JOIN Группа гр ON р.код_группы = гр.код_группы
INNER JOIN Предметы пр ON р.код_предмета = пр.код_предмета
INNER JOIN Тип_занятий_аудиторий т ON р.код_типа_занятий = т.код
INNER JOIN Аудитории ау ON р.номер_ауд = ау.номер_ауд
INNER JOIN Преподаватели прп ON р.код_преподавателя = прп.код_преподавателя
INNER JOIN Кафедры к ON прп.код_кафедры = к.код_кафедры
WITH CHECK OPTION;
GO

-- ===================================================
-- ЗАДАНИЕ 3: ПРЕДСТАВЛЕНИЕ ДЛЯ КОРРЕКТИРОВКИ (1 ТАБЛИЦА)
-- ===================================================

CREATE VIEW vw_Корректировка_Преподавателей AS
SELECT 
    код_преподавателя,
    ФИО,
    код_кафедры
FROM Преподаватели
WITH CHECK OPTION;
GO

-- ===================================================
-- ДОПОЛНИТЕЛЬНОЕ ПРЕДСТАВЛЕНИЕ ДЛЯ КОРРЕКТИРОВКИ ГРУПП
-- ===================================================

CREATE VIEW vw_Корректировка_Групп AS
SELECT 
    код_группы,
    наименование AS Группа,
    код_кафедры,
    численность_группы,
    Курс
FROM Группа
WITH CHECK OPTION;
GO

-- ===================================================
-- ПРОВЕРКА СОЗДАННЫХ ПРЕДСТАВЛЕНИЙ
-- ===================================================

PRINT '=== ПРЕДСТАВЛЕНИЯ УСПЕШНО СОЗДАНЫ! ===';
PRINT 'Список созданных представлений:';

SELECT 
    name AS Имя_Представления,
    create_date AS Дата_Создания
FROM sys.views 
WHERE name LIKE 'vw_%';
GO

-- 1. Посмотреть список всех представлений
SELECT name FROM sys.views WHERE name LIKE 'vw_%';

-- 2. Посмотреть структуру конкретного представления
EXEC sp_help 'vw_Отчет_Полное_Расписание';

-- 3. Посмотреть SQL-код представления
EXEC sp_helptext 'vw_Отчет_Полное_Расписание';

-- ТЕСТИРУЕМ ОТЧЕТЫ (ЗАДАНИЕ 1)
-- 1. Полное расписание
SELECT * FROM vw_Отчет_Полное_Расписание 
WHERE Группа = 'ИВТ-22-1'
ORDER BY 
    CASE день_недели
        WHEN 'Понедельник' THEN 1
        WHEN 'Вторник' THEN 2
        WHEN 'Среда' THEN 3
        WHEN 'Четверг' THEN 4
        WHEN 'Пятница' THEN 5
        WHEN 'Суббота' THEN 6
    END, номер_занятия;

-- 2. Нагрузка преподавателей
SELECT * FROM vw_Отчет_Нагрузка_Преподавателей 
ORDER BY Преподаватель, день_недели;

-- 3. Статистика аудиторий
SELECT * FROM vw_Отчет_Статистика_Аудиторий 
ORDER BY Занятых_пар_в_неделю DESC;
-- ТЕСТИРУЕМ КОРРЕКТИРОВКУ (ЗАДАНИЕ 2 и 3)
-- 1. Просмотр расписания для корректировки
SELECT * FROM vw_Корректировка_Расписания 
WHERE день_недели = 'Понедельник'
ORDER BY номер_занятия;

-- 2. Просмотр преподавателей для корректировки
SELECT * FROM vw_Корректировка_Преподавателей 
ORDER BY ФИО;

-- 3. Просмотр групп для корректировки
SELECT * FROM vw_Корректировка_Групп 
ORDER BY Курс, Группа;

-- ТЕСТ ОБНОВЛЕНИЯ ЧЕРЕЗ ПРЕДСТАВЛЕНИЯ
-- 1. Обновить аудиторию через представление расписания
UPDATE vw_Корректировка_Расписания 
SET номер_ауд = 201 
WHERE день_недели = 'Понедельник' 
AND номер_занятия = 1 
AND код_группы = 1;

-- 2. Обновить ФИО преподавателя
UPDATE vw_Корректировка_Преподавателей 
SET ФИО = 'Иванов А.С. (старший)' 
WHERE код_преподавателя = 1;

-- 3. Обновить численность группы
UPDATE vw_Корректировка_Групп 
SET численность_группы = 30 
WHERE код_группы = 1;

-- Проверить изменения
SELECT * FROM vw_Корректировка_Расписания WHERE код_группы = 1;
SELECT * FROM vw_Корректировка_Преподавателей WHERE код_преподавателя = 1;
SELECT * FROM vw_Корректировка_Групп WHERE код_группы = 1;

-- ===================================================
-- ТЕСТИРОВАНИЕ КОРРЕКТИРОВКИ ДАННЫХ ЧЕРЕЗ ПРЕДСТАВЛЕНИЯ
-- ===================================================

PRINT '=== НАЧАЛО ТЕСТА КОРРЕКТИРОВКИ ===';

-- Проверим исходные данные
PRINT '1. ИСХОДНЫЕ ДАННЫЕ:';
SELECT 'Расписание' as Таблица, день_недели, номер_занятия, код_группы, номер_ауд 
FROM vw_Корректировка_Расписания 
WHERE код_группы = 1 AND день_недели = 'Понедельник' AND номер_занятия = 1;

SELECT 'Преподаватели' as Таблица, код_преподавателя, ФИО 
FROM vw_Корректировка_Преподавателей 
WHERE код_преподавателя = 1;

SELECT 'Группы' as Таблица, код_группы, Группа, численность_группы 
FROM vw_Корректировка_Групп 
WHERE код_группы = 1;
GO

-- Выполним обновления
PRINT '2. ВЫПОЛНЯЕМ ОБНОВЛЕНИЯ...';

BEGIN TRY
    -- 1. Обновить аудиторию через представление расписания
    UPDATE vw_Корректировка_Расписания 
    SET номер_ауд = 201 
    WHERE день_недели = 'Понедельник' 
    AND номер_занятия = 1 
    AND код_группы = 1;
    
    PRINT ' Аудитория обновлена успешно';
    
    -- 2. Обновить ФИО преподавателя
    UPDATE vw_Корректировка_Преподавателей 
    SET ФИО = 'Иванов А.С. (старший)' 
    WHERE код_преподавателя = 1;
    
    PRINT ' ФИО преподавателя обновлено успешно';
    
    -- 3. Обновить численность группы
    UPDATE vw_Корректировка_Групп 
    SET численность_группы = 30 
    WHERE код_группы = 1;
    
    PRINT ' Численность группы обновлена успешно';
    
END TRY
BEGIN CATCH
    PRINT ' Ошибка при обновлении: ' + ERROR_MESSAGE();
END CATCH
GO

-- Проверим изменения
PRINT '3. ПРОВЕРЯЕМ ИЗМЕНЕНИЯ:';

SELECT 'Расписание после изменений' as Таблица, день_недели, номер_занятия, код_группы, номер_ауд 
FROM vw_Корректировка_Расписания 
WHERE код_группы = 1 AND день_недели = 'Понедельник' AND номер_занятия = 1;

SELECT 'Преподаватели после изменений' as Таблица, код_преподавателя, ФИО 
FROM vw_Корректировка_Преподавателей 
WHERE код_преподавателя = 1;

SELECT 'Группы после изменений' as Таблица, код_группы, Группа, численность_группы 
FROM vw_Корректировка_Групп 
WHERE код_группы = 1;

PRINT '=== ТЕСТ ЗАВЕРШЕН ===';
GO
-- Проверим все представления сразу
SELECT '1. ОТЧЕТЫ' as Категория, name as Представление 
FROM sys.views WHERE name LIKE 'vw_Отчет%'
UNION ALL
SELECT '2. КОРРЕКТИРОВКА', name 
FROM sys.views WHERE name LIKE 'vw_Корректировка%';

-- Проверим что представления возвращают данные
SELECT TOP 3 'vw_Отчет_Полное_Расписание' as Представление, * FROM vw_Отчет_Полное_Расписание;
SELECT TOP 3 'vw_Корректировка_Расписания' as Представление, * FROM vw_Корректировка_Расписания;
SELECT TOP 3 'vw_Корректировка_Преподавателей' as Представление, * FROM vw_Корректировка_Преподавателей;