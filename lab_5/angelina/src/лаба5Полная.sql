-- ===================================================
-- ЛАБОРАТОРНАЯ РАБОТА №5 - ХРАНИМЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ
-- БАЗА ДАННЫХ: Расписание_занятий_Л
-- ВАРИАНТ: 8
-- ===================================================

USE Расписание_занятий_Л;
GO

-- ===================================================
-- ЧАСТЬ а): ХРАНИМЫЕ ПРОЦЕДУРЫ СОГЛАСНО ВАРИАНТУ 8
-- ===================================================

-- 1. Процедура: У каких преподавателей можно прослушать курс лекций по «I-ой» дисциплине
CREATE PROCEDURE sp_ПреподавателиПоДисциплине
    @код_дисциплины INT
AS
BEGIN
    SELECT DISTINCT 
        п.код_преподавателя,
        п.ФИО AS Преподаватель,
        к.наименование AS Кафедра
    FROM Преподаватели п
    INNER JOIN Расписание р ON п.код_преподавателя = р.код_преподавателя
    INNER JOIN Предметы пр ON р.код_предмета = пр.код_предмета
    INNER JOIN Тип_занятий_аудиторий т ON р.код_типа_занятий = т.код
    INNER JOIN Кафедры к ON п.код_кафедры = к.код_кафедры
    WHERE пр.код_предмета = @код_дисциплины 
      AND т.наименование = 'лекции';
END;
GO

-- 2. Процедура: Расписание занятий для студентов I-ой группы
CREATE PROCEDURE sp_РасписаниеГруппы
    @код_группы INT
AS
BEGIN
    SELECT 
        р.день_недели AS День_недели,
        р.номер_занятия AS Номер_пары,
        пер.время_начала AS Начало,
        пер.время_окончания AS Окончание,
        пр.наименование AS Предмет,
        т.наименование AS Тип_занятия,
        ау.номер_ауд AS Аудитория,
        прп.ФИО AS Преподаватель
    FROM Расписание р
    INNER JOIN Период_проведения_занятий пер ON р.номер_занятия = пер.номер_занятия
    INNER JOIN Предметы пр ON р.код_предмета = пр.код_предмета
    INNER JOIN Тип_занятий_аудиторий т ON р.код_типа_занятий = т.код
    INNER JOIN Аудитории ау ON р.номер_ауд = ау.номер_ауд
    INNER JOIN Преподаватели прп ON р.код_преподавателя = прп.код_преподавателя
    WHERE р.код_группы = @код_группы
    ORDER BY 
        CASE р.день_недели
            WHEN 'Понедельник' THEN 1
            WHEN 'Вторник' THEN 2
            WHEN 'Среда' THEN 3
            WHEN 'Четверг' THEN 4
            WHEN 'Пятница' THEN 5
            WHEN 'Суббота' THEN 6
        END, 
        р.номер_занятия;
END;
GO

-- 3. Процедура: Из таблицы Аудитории выбрать строки по условию: количество посадочных мест > 50
CREATE PROCEDURE sp_АудиторииБольше50
AS
BEGIN
    SELECT 
        а.номер_ауд AS Аудитория,
        т.наименование AS Тип_аудитории,
        а.количество_посадочных_мест AS Посадочных_мест
    FROM Аудитории а
    INNER JOIN Тип_занятий_аудиторий т ON а.код_типа_занятий = т.код
    WHERE а.количество_посадочных_мест > 50
    ORDER BY а.количество_посадочных_мест DESC;
END;
GO

-- ===================================================
-- ЧАСТЬ б): ПОЛЬЗОВАТЕЛЬСКИЕ ФУНКЦИИ
-- ===================================================

-- 1. Скалярная функция: Расчет общей нагрузки преподавателя в часах в неделю
CREATE FUNCTION dbo.ufn_НагрузкаПреподавателя
(
    @код_преподавателя INT
)
RETURNS DECIMAL(5,2)
AS
BEGIN
    DECLARE @общая_нагрузка DECIMAL(5,2);
    
    SELECT @общая_нагрузка = COUNT(*) * 1.5
    FROM Расписание 
    WHERE код_преподавателя = @код_преподавателя;
    
    RETURN ISNULL(@общая_нагрузка, 0);
END;
GO

-- 2. Скалярная функция: Проверка возможности размещения группы в аудитории
CREATE FUNCTION dbo.ufn_ПроверитьВместимость
(
    @код_группы INT,
    @номер_аудитории INT
)
RETURNS NVARCHAR(50)
AS
BEGIN
    DECLARE @результат NVARCHAR(50);
    DECLARE @численность_группы INT;
    DECLARE @вместимость_аудитории INT;
    
    SELECT @численность_группы = численность_группы 
    FROM Группа 
    WHERE код_группы = @код_группы;
    
    SELECT @вместимость_аудитории = количество_посадочных_мест 
    FROM Аудитории 
    WHERE номер_ауд = @номер_аудитории;
    
    IF @численность_группы IS NULL OR @вместимость_аудитории IS NULL
        SET @результат = 'Ошибка: данные не найдены';
    ELSE IF @численность_группы <= @вместимость_аудитории
        SET @результат = 'Группа помещается';
    ELSE
        SET @результат = 'Аудитория мала для группы';
    
    RETURN @результат;
END;
GO

-- 3. Табличная функция: Расписание преподавателя на указанный день
CREATE FUNCTION dbo.ufn_РасписаниеПреподавателяНаДень
(
    @код_преподавателя INT,
    @день_недели NVARCHAR(15)
)
RETURNS TABLE
AS
RETURN
(
    SELECT 
        р.номер_занятия AS Пара,
        пер.время_начала AS Начало,
        пер.время_окончания AS Конец,
        пр.наименование AS Предмет,
        т.наименование AS Тип,
        гр.наименование AS Группа,
        ау.номер_ауд AS Аудитория
    FROM Расписание р
    INNER JOIN Период_проведения_занятий пер ON р.номер_занятия = пер.номер_занятия
    INNER JOIN Предметы пр ON р.код_предмета = пр.код_предмета
    INNER JOIN Тип_занятий_аудиторий т ON р.код_типа_занятий = т.код
    INNER JOIN Группа гр ON р.код_группы = гр.код_группы
    INNER JOIN Аудитории ау ON р.номер_ауд = ау.номер_ауд
    WHERE р.код_преподавателя = @код_преподавателя 
      AND р.день_недели = @день_недели
);
GO

-- ===================================================
-- ТЕСТИРОВАНИЕ
-- ===================================================

-- Тест процедур
PRINT '=== ТЕСТ ХРАНИМЫХ ПРОЦЕДУР ===';
EXEC sp_ПреподавателиПоДисциплине @код_дисциплины = 1;
EXEC sp_РасписаниеГруппы @код_группы = 1;
EXEC sp_АудиторииБольше50;

-- Тест функций
PRINT '=== ТЕСТ ФУНКЦИЙ ===';
SELECT dbo.ufn_НагрузкаПреподавателя(1) AS Нагрузка;
SELECT dbo.ufn_ПроверитьВместимость(1, 101) AS Проверка;
SELECT * FROM dbo.ufn_РасписаниеПреподавателяНаДень(1, 'Понедельник');

PRINT '=== ЛАБОРАТОРНАЯ РАБОТА №5 ВЫПОЛНЕНА ===';